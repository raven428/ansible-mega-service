---
- name: Destroy check services
  ansible.builtin.systemd:
    name: "{{ service.systemd.name }}"
  register: services_statuses
  loop_control:
    loop_var: service
  loop: "{{ mesv_install_service }}"

- name: Destroy fail running
  ansible.builtin.fail:
    msg: "Stop [{{ active_services | join(',') }}] services first"
  when: "active_services | length > 0"
  ignore_errors: "{{ ansible_check_mode }}"
  vars:
    active_services: "{{ services_statuses.results | selectattr('status.ActiveState',
      'equalto', 'active') | selectattr('status.SubState', 'equalto', 'running') |
      map(attribute='service.systemd.name') | list }}"

- name: Destroy packages remove
  ansible.builtin.include_role:
    name: ansible-mega-var
    tasks_from: _apt.yaml
  vars:
    meva_packages: "{{ mesv_install_pkgs | default([]) | selectattr('package',
      'defined') | map(attribute='package') | map('combine', {'state': 'absent',
      'autoremove': true, 'purge': true}) | list }}"

- name: Remove apt keys
  ansible.builtin.apt_key:
  args: "{{ i.repo_key }}"
  register: _temp_result
  until: _temp_result is succeeded
  retries: 3
  delay: 1
  loop_control:
    loop_var: i
  loop: "{{ mesv_install_pkgs | default([]) | map('combine', {'repo_key': {'state':
    'absent'}}, recursive=True) | list }}"

- name: Destroy users keys
  ansible.builtin.include_role:
    name: ansible-mega-var
    tasks_from: _key.yaml
  vars:
    meva_key2user: "{{ mesv_install_key2user | default([]) | map('combine',
      {'state': 'absent'}) | list }}"

- name: Destroy users remove
  ansible.builtin.include_role:
    name: ansible-mega-var
    tasks_from: _user.yaml
  vars:
    meva_users2create: "{{ mesv_install_users | default([]) | map('combine',
      {'state': 'absent'}) | list }}"

- name: Destroy groups remove
  ansible.builtin.include_role:
    name: ansible-mega-var
    tasks_from: _group.yaml
  vars:
    meva_groups2create: "{{ mesv_install_groups | default([]) | map('combine',
      {'state': 'absent'}) | list }}"

- name: Destroy dirs remove
  ansible.builtin.include_role:
    name: ansible-mega-var
    tasks_from: _file.yaml
  vars:
    meva_dirs2create: "{{ (mesv_install_templates | default([]) + mesv_config_templates |
      default([]) + mesv_remove_entries | default([])) | map(attribute='dest') |
      map('community.general.dict_kv', 'name') | map('combine', {'state': 'absent'}) |
      list }}"
